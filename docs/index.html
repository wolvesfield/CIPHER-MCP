<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¨ CIPHER ComfyUI Generator</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --card: #22263a;
    --border: #2e3250;
    --accent: #7c6af7;
    --accent2: #4fc3f7;
    --success: #4caf7d;
    --warn: #f7c948;
    --text: #e8eaf6;
    --muted: #8b90b8;
    --radius: 12px;
    --font: "Segoe UI", system-ui, sans-serif;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    font-size: 16px;
    line-height: 1.6;
    min-height: 100vh;
  }
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  header h1 { font-size: 1.4rem; font-weight: 700; }
  header span { font-size: 0.85rem; color: var(--muted); }
  .status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--success); flex-shrink: 0;
    box-shadow: 0 0 6px var(--success);
  }
  nav {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    display: flex; flex-wrap: wrap; gap: 4px;
    padding: 8px 16px;
    position: sticky; top: 0; z-index: 100;
  }
  nav button {
    background: transparent;
    border: 1px solid transparent;
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 8px 16px;
    transition: all .15s;
  }
  nav button:hover { background: var(--card); color: var(--text); }
  nav button.active {
    background: var(--card);
    border-color: var(--accent);
    color: var(--accent);
  }
  .tab { display: none; }
  .tab.active { display: block; }
  main { max-width: 900px; margin: 0 auto; padding: 32px 20px 80px; }
  h2 { font-size: 1.5rem; margin-bottom: 6px; }
  .subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 24px; }
  label {
    display: block; font-size: 0.85rem; font-weight: 600;
    color: var(--muted); margin-bottom: 6px; margin-top: 16px;
  }
  label:first-of-type { margin-top: 0; }
  textarea, input[type="text"], input[type="number"], select {
    width: 100%;
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-size: 1rem;
    font-family: var(--font);
    padding: 12px 14px;
    resize: vertical;
    transition: border-color .15s;
    outline: none;
  }
  textarea:focus, input:focus, select:focus { border-color: var(--accent); }
  textarea { min-height: 90px; }
  .preset-row { display: flex; gap: 10px; flex-wrap: wrap; margin: 14px 0; }
  .preset-btn {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    padding: 10px 20px;
    transition: all .15s;
    flex: 1; min-width: 100px;
  }
  .preset-btn:hover { border-color: var(--accent); color: var(--accent); }
  .preset-btn.selected { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn {
    background: var(--accent);
    border: none;
    border-radius: var(--radius);
    color: #fff;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 700;
    padding: 14px 28px;
    transition: opacity .15s;
    display: inline-flex; align-items: center; gap: 8px;
    margin-top: 20px;
  }
  .btn:hover { opacity: .85; }
  .btn:disabled { opacity: .45; cursor: not-allowed; }
  .result-box {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-top: 20px;
    overflow: hidden;
    display: none;
  }
  .result-box.visible { display: block; }
  .result-header {
    background: var(--surface);
    padding: 10px 16px;
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--muted);
    display: flex; justify-content: space-between; align-items: center;
  }
  .copy-btn {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    cursor: pointer;
    font-size: 0.75rem;
    padding: 4px 10px;
  }
  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
  pre {
    background: transparent;
    color: var(--accent2);
    font-family: Consolas, "Courier New", monospace;
    font-size: 0.82rem;
    line-height: 1.5;
    overflow-x: auto;
    padding: 16px;
    white-space: pre-wrap;
    word-break: break-all;
  }
  .error-msg {
    background: #2a1a1a;
    border: 1px solid #7a2020;
    border-radius: var(--radius);
    color: #f88;
    margin-top: 16px;
    padding: 12px 16px;
    display: none;
  }
  .error-msg.visible { display: block; }
  .loader {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2.5px solid rgba(255,255,255,.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin .7s linear infinite;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 600px) { .row { grid-template-columns: 1fr; } }
  .info-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 12px;
  }
  .info-card h3 { font-size: 1rem; margin-bottom: 6px; }
  .info-card p, .info-card li { font-size: 0.88rem; color: var(--muted); }
  .info-card ul { padding-left: 18px; }
  .info-card li { margin-bottom: 4px; }
  .badge {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 999px;
    display: inline-block;
    font-size: 0.75rem;
    margin: 2px;
    padding: 3px 10px;
    color: var(--muted);
  }
  .badge.lora { border-color: var(--accent); color: var(--accent); }
  .badge.checkpoint { border-color: var(--accent2); color: var(--accent2); }
  .model-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 18px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
  }
  .model-card .model-info { flex: 1; min-width: 0; }
  .model-card .model-name {
    font-weight: 700; font-size: 0.95rem; margin-bottom: 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .model-card a {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--accent2);
    font-size: 0.8rem;
    font-weight: 600;
    padding: 6px 14px;
    text-decoration: none;
    white-space: nowrap;
    flex-shrink: 0;
    align-self: center;
  }
  .model-card a:hover { border-color: var(--accent2); }
  .step-list { counter-reset: steps; list-style: none; padding: 0; }
  .step-list li {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    counter-increment: steps;
    display: flex;
    gap: 14px;
    margin-bottom: 10px;
    padding: 14px 18px;
  }
  .step-list li::before {
    content: counter(steps);
    background: var(--accent);
    border-radius: 50%;
    color: #fff;
    font-size: 0.85rem;
    font-weight: 700;
    width: 26px; height: 26px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .step-content { flex: 1; }
  .step-content strong { display: block; font-size: 0.9rem; margin-bottom: 2px; }
  .step-content span { font-size: 0.82rem; color: var(--muted); }
  .range-row { display: flex; align-items: center; gap: 12px; }
  .range-row input[type=range] { flex: 1; accent-color: var(--accent); }
  .range-val { min-width: 38px; text-align: right; font-size: 0.9rem; font-weight: 700; }
  hr { border: none; border-top: 1px solid var(--border); margin: 28px 0; }
  .civitai-notice {
    background: #1a1f2e;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.85rem;
    color: var(--muted);
    padding: 10px 16px;
    margin-bottom: 16px;
  }
  .civitai-notice a { color: var(--accent2); }
</style>
</head>
<body>

<header>
  <div class="status-dot"></div>
  <h1>ğŸ¨ CIPHER ComfyUI Generator</h1>
  <span>WAN Â· FLUX Â· SDXL Â· Civitai Â· LoRA</span>
</header>

<nav id="nav">
  <button class="active" onclick="showTab('t2v', this)">ğŸ¬ Text â†’ Video</button>
  <button onclick="showTab('i2v', this)">ğŸ–¼ï¸ Image â†’ Video</button>
  <button onclick="showTab('i2i', this)">âœ¨ Restyle</button>
  <button onclick="showTab('enhance', this)">ğŸ” Enhance</button>
  <button onclick="showTab('civitai', this)">ğŸ” Civitai</button>
  <button onclick="showTab('lora', this)">ğŸ“ Train LoRA</button>
  <button onclick="showTab('models', this)">ğŸ“¦ Models</button>
</nav>

<main>

<!-- ===== Text â†’ Video ===== -->
<div class="tab active" id="tab-t2v">
  <h2>ğŸ¬ Text â†’ Video</h2>
  <p class="subtitle">Describe your video idea and pick a quality preset. Copy the payload into your ComfyUI / WAN backend.</p>

  <label for="t2v-prompt">Your video idea</label>
  <textarea id="t2v-prompt" placeholder="e.g. neon samurai walking through rainy cyberpunk Tokyo at night, cinematic slow-mo"></textarea>

  <label>Quality preset</label>
  <div class="preset-row">
    <button class="preset-btn" onclick="setPreset('t2v','fast',this)">âš¡ Fast<br><small style="color:var(--muted);font-weight:400">832Ã—480 Â· 81f Â· ~5s</small></button>
    <button class="preset-btn selected" onclick="setPreset('t2v','quality',this)">âœ¨ Quality<br><small style="color:var(--muted);font-weight:400">1280Ã—720 Â· 121f Â· ~5s</small></button>
    <button class="preset-btn" onclick="setPreset('t2v','best',this)">ğŸ† Best<br><small style="color:var(--muted);font-weight:400">1536Ã—864 Â· 161f Â· ~7s</small></button>
  </div>

  <button class="btn" id="t2v-btn" onclick="runT2V()">ğŸ¬ Build Payload</button>
  <div class="error-msg" id="t2v-err"></div>
  <div class="result-box" id="t2v-result">
    <div class="result-header">
      PAYLOAD â€” paste this into your ComfyUI / WAN backend
      <button class="copy-btn" onclick="copyResult('t2v-pre')">ğŸ“‹ Copy</button>
    </div>
    <pre id="t2v-pre"></pre>
  </div>
</div>

<!-- ===== Image â†’ Video ===== -->
<div class="tab" id="tab-i2v">
  <h2>ğŸ–¼ï¸ Image â†’ Video</h2>
  <p class="subtitle">Animate a still image. Enter the image file path and describe the motion you want.</p>

  <label for="i2v-path">Image path or URL</label>
  <input type="text" id="i2v-path" placeholder="./my-image.png  or  https://example.com/image.jpg">

  <label for="i2v-prompt">Motion / camera description</label>
  <textarea id="i2v-prompt" placeholder="e.g. slow zoom out revealing the full scene, golden hour light, gentle wind in hair"></textarea>

  <label>Quality preset</label>
  <div class="preset-row">
    <button class="preset-btn" onclick="setPreset('i2v','fast',this)">âš¡ Fast</button>
    <button class="preset-btn selected" onclick="setPreset('i2v','quality',this)">âœ¨ Quality</button>
    <button class="preset-btn" onclick="setPreset('i2v','best',this)">ğŸ† Best</button>
  </div>

  <button class="btn" onclick="runI2V()">ğŸ¬ Build Payload</button>
  <div class="error-msg" id="i2v-err"></div>
  <div class="result-box" id="i2v-result">
    <div class="result-header">PAYLOAD <button class="copy-btn" onclick="copyResult('i2v-pre')">ğŸ“‹ Copy</button></div>
    <pre id="i2v-pre"></pre>
  </div>
</div>

<!-- ===== Restyle ===== -->
<div class="tab" id="tab-i2i">
  <h2>âœ¨ Restyle Image</h2>
  <p class="subtitle">Transform the style of an existing image using FLUX / SDXL + LoRA.</p>

  <label for="i2i-path">Image path or URL</label>
  <input type="text" id="i2i-path" placeholder="./my-photo.jpg">

  <label for="i2i-prompt">Target style</label>
  <textarea id="i2i-prompt" placeholder="e.g. luxury product ad, studio lighting, marble background, ultra clean"></textarea>

  <label>Strength â€” 0 = keep original Â· 1 = full repaint</label>
  <div class="range-row">
    <input type="range" id="i2i-strength" min="0.15" max="0.95" step="0.05" value="0.55"
      oninput="document.getElementById('i2i-sv').textContent=parseFloat(this.value).toFixed(2)">
    <span class="range-val" id="i2i-sv">0.55</span>
  </div>

  <button class="btn" onclick="runI2I()">âœ¨ Build Payload</button>
  <div class="error-msg" id="i2i-err"></div>
  <div class="result-box" id="i2i-result">
    <div class="result-header">PAYLOAD <button class="copy-btn" onclick="copyResult('i2i-pre')">ğŸ“‹ Copy</button></div>
    <pre id="i2i-pre"></pre>
  </div>
</div>

<!-- ===== Enhance ===== -->
<div class="tab" id="tab-enhance">
  <h2>ğŸ” Enhance / Upscale</h2>
  <p class="subtitle">Upscale and sharpen any image using Real-ESRGAN + optional face restore.</p>

  <label for="enhance-path">Image path or URL</label>
  <input type="text" id="enhance-path" placeholder="./output.png">

  <label>Scale factor</label>
  <div class="preset-row">
    <button class="preset-btn" onclick="setPreset('enhance','2',this)">ğŸ” Ã—2<br><small style="color:var(--muted);font-weight:400">Portraits</small></button>
    <button class="preset-btn selected" onclick="setPreset('enhance','4',this)">ğŸ” Ã—4<br><small style="color:var(--muted);font-weight:400">Landscape / product</small></button>
  </div>

  <button class="btn" onclick="runEnhance()">ğŸ” Build Payload</button>
  <div class="error-msg" id="enhance-err"></div>
  <div class="result-box" id="enhance-result">
    <div class="result-header">PAYLOAD <button class="copy-btn" onclick="copyResult('enhance-pre')">ğŸ“‹ Copy</button></div>
    <pre id="enhance-pre"></pre>
  </div>
</div>

<!-- ===== Civitai ===== -->
<div class="tab" id="tab-civitai">
  <h2>ğŸ” Find Models on Civitai</h2>
  <p class="subtitle">Search Civitai for LoRA and Checkpoint models. Click a result to open it on Civitai.</p>

  <div class="civitai-notice">
    Results come directly from <a href="https://civitai.com" target="_blank" rel="noopener">civitai.com</a>.
    Clicking <strong>Open â†—</strong> takes you to the model page where you can download it.
  </div>

  <label for="civitai-q">Search term</label>
  <div style="display:flex;gap:10px">
    <input type="text" id="civitai-q"
      placeholder="e.g.  wan video cinematic   or   anime lora   or   realistic portrait"
      onkeydown="if(event.key==='Enter') runCivitai()">
    <button class="btn" style="margin-top:0;flex-shrink:0" onclick="runCivitai()">ğŸ” Search</button>
  </div>

  <div class="error-msg" id="civitai-err"></div>
  <div id="civitai-results" style="margin-top:20px"></div>
</div>

<!-- ===== Train LoRA ===== -->
<div class="tab" id="tab-lora">
  <h2>ğŸ“ Train a LoRA</h2>
  <p class="subtitle">Fill in these simple fields to get a ready-to-run <strong>kohya_ss</strong> training command. No coding needed.</p>

  <ol class="step-list" style="margin-bottom:28px">
    <li>
      <div class="step-content">
        <strong>Collect 10â€“30 images of your subject</strong>
        <span>Put them in one folder. Each image should clearly show what you want to teach the model â€” a character, art style, object, etc.</span>
      </div>
    </li>
    <li>
      <div class="step-content">
        <strong>Write a caption (.txt) for each image</strong>
        <span>Same filename as the image, just .txt extension. Describe what's in it. e.g. "photo of cyborg samurai, neon armor, Tokyo background".</span>
      </div>
    </li>
    <li>
      <div class="step-content">
        <strong>Fill in the form below and click Generate Config</strong>
        <span>You'll get a complete training command. Paste it into kohya_ss or your RunPod training environment.</span>
      </div>
    </li>
    <li>
      <div class="step-content">
        <strong>Upload your trained LoRA to Civitai</strong>
        <span>The output includes step-by-step Civitai upload instructions so your LoRA is searchable by everyone.</span>
      </div>
    </li>
  </ol>

  <div class="row">
    <div>
      <label for="lora-dataset">Dataset folder path</label>
      <input type="text" id="lora-dataset" placeholder="./dataset/my_subject">
    </div>
    <div>
      <label for="lora-output">Output LoRA name</label>
      <input type="text" id="lora-output" placeholder="my_lora_v1">
    </div>
  </div>

  <label for="lora-base">Base model</label>
  <select id="lora-base">
    <option value="stabilityai/stable-diffusion-xl-base-1.0">SDXL 1.0 â€” recommended for images</option>
    <option value="black-forest-labs/FLUX.1-dev">FLUX.1-dev â€” best quality, slower</option>
    <option value="Wan-AI/Wan2.1-T2V-14B">WAN 2.1 T2V 14B â€” video LoRA</option>
    <option value="Wan-AI/Wan2.1-T2V-5B">WAN 2.1 T2V 5B â€” faster video LoRA</option>
  </select>

  <div class="row">
    <div>
      <label for="lora-steps">Training steps</label>
      <input type="number" id="lora-steps" value="1000" min="100" max="10000">
    </div>
    <div>
      <label for="lora-res">Resolution (px)</label>
      <input type="number" id="lora-res" value="512" min="256" max="1024" step="64">
    </div>
  </div>

  <div class="row">
    <div>
      <label for="lora-lr">Learning rate</label>
      <input type="text" id="lora-lr" value="0.0001" placeholder="0.0001">
    </div>
    <div>
      <label for="lora-dim">Network dim (detail level, 4â€“128)</label>
      <input type="number" id="lora-dim" value="32" min="4" max="128" step="4">
    </div>
  </div>

  <button class="btn" onclick="runLora()">ğŸ“ Generate Training Config</button>
  <div class="error-msg" id="lora-err"></div>
  <div class="result-box" id="lora-result">
    <div class="result-header">
      TRAINING CONFIG + CIVITAI UPLOAD STEPS
      <button class="copy-btn" onclick="copyResult('lora-pre')">ğŸ“‹ Copy</button>
    </div>
    <pre id="lora-pre"></pre>
  </div>
</div>

<!-- ===== Models ===== -->
<div class="tab" id="tab-models">
  <h2>ğŸ“¦ Supported Models</h2>
  <p class="subtitle">Reference list of recommended WAN, FLUX, and SDXL models for use with this generator.</p>
  <div id="models-cards"></div>
</div>

</main>

<script>
"use strict";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  t2v: { mode: "quality" },
  i2v: { mode: "quality" },
  enhance: { scale: "4" },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WAN payload generators (ported from comfy_ui_generator.py)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const T2V_PRESETS = {
  fast:    { model_hint: "WAN 2.1 T2V 1.3B/5B", frames: 81,  fps: 16, steps: 20, cfg: 4.0, sampler: "DPM++ 2M Karras",  denoise_strength: 0.9, resolution: "832x480",  duration_hint: "~5s" },
  quality: { model_hint: "WAN 2.1 T2V 14B",      frames: 121, fps: 24, steps: 30, cfg: 5.5, sampler: "DPM++ SDE Karras", denoise_strength: 1.0, resolution: "1280x720", duration_hint: "~5s" },
  best:    { model_hint: "WAN 2.1 T2V 14B + hi-res pass", frames: 161, fps: 24, steps: 36, cfg: 6.0, sampler: "DPM++ SDE Karras", denoise_strength: 1.0, resolution: "1536x864", duration_hint: "~6-7s" },
};

const I2V_PRESETS = {
  fast:    { frames: 81,  fps: 16, steps: 20, cfg: 4.0, resolution: "832x480" },
  quality: { frames: 121, fps: 24, steps: 30, cfg: 5.5, resolution: "1280x720" },
  best:    { frames: 161, fps: 24, steps: 36, cfg: 6.0, resolution: "1536x864" },
};

function wanCombo(idea, mode) {
  const m = T2V_PRESETS[mode] ? mode : "best";
  return {
    generator: "WAN video combo",
    mode: m,
    prompt_positive: `${idea}, cinematic composition, coherent motion, natural physics, high detail textures, volumetric lighting, stable subject consistency, clean temporal consistency, film color grading, sharp focus`,
    prompt_negative: "flicker, temporal jitter, warping, morphing face, extra limbs, lowres, blurry, text watermark, compression artifacts, noisy shadows, over-saturated",
    settings: { ...T2V_PRESETS[m] },
    workflow_notes: [
      "Use fixed seed for first pass; vary seed only after baseline quality is good.",
      "Start with mode=quality, then move to mode=best for final renders.",
      "For character shots, keep camera movement simple to maximise temporal stability.",
    ],
  };
}

function wanI2V(imagePath, idea, mode) {
  const m = I2V_PRESETS[mode] ? mode : "quality";
  return {
    task: "image-to-video",
    engine: "WAN",
    mode: m,
    input_image: imagePath,
    prompt: `${idea}, preserve subject identity, smooth temporal motion, cinematic lighting`,
    negative_prompt: "flicker, temporal jitter, morphing face, lowres, blurry",
    settings: {
      ...I2V_PRESETS[m],
      model_hint: `WAN 2.1 I2V ${m !== "fast" ? "14B" : "5B"}`,
      sampler: "DPM++ SDE Karras",
      motion_strength: 0.65,
      seed: 12345,
      duration_hint: "4-7s",
    },
  };
}

function wanI2I(imagePath, idea, strength) {
  const s = Math.round(Math.max(0.15, Math.min(0.95, strength)) * 100) / 100;
  return {
    task: "image-to-image",
    engine: "SDXL/FLUX",
    input_image: imagePath,
    prompt: `${idea}, high detail, clean composition, premium colour grading`,
    negative_prompt: "artifact, deformed anatomy, oversharpen, text watermark",
    settings: {
      model_hint: "FLUX.1-dev or SDXL + LoRA",
      steps: 28, cfg: 6.0,
      sampler: "DPM++ 2M Karras",
      denoise_strength: s,
      resolution: "match_source",
      seed: 12345,
    },
  };
}

function wanEnhance(imagePath, scale) {
  const s = scale <= 2 ? 2 : 4;
  return {
    task: "enhance",
    input_image: imagePath,
    pipeline: [
      { stage: "upscale", model_hint: `Real-ESRGAN x${s}`, scale: s },
      { stage: "optional_face_restore", model_hint: "CodeFormer", fidelity: 0.65 },
      { stage: "final_sharpen", method: "unsharp_mask", amount: 0.35 },
    ],
    notes: [
      "Use x2 for soft portraits, x4 for product/landscape details.",
      "Do not over-sharpen after face restore to avoid halo artifacts.",
    ],
  };
}

function wanModels() {
  return {
    video_t2v: ["WAN 2.1 T2V 14B", "WAN 2.1 T2V 5B", "WAN 2.1 T2V 1.3B"],
    video_i2v: ["WAN 2.1 I2V 14B", "WAN 2.1 I2V 5B"],
    image_i2i: ["FLUX.1-dev + style LoRA", "SDXL base + style LoRA"],
    enhance:   ["Real-ESRGAN x2/x4", "4x-UltraSharp", "CodeFormer (face restore)"],
    notes: [
      "Use quality mode for iteration, best mode for final export.",
      "Keep LoRA weight 0.6â€“0.9 to reduce artifacts.",
      "For i2v consistency, start with minimal camera motion and 4-7 s duration.",
    ],
  };
}

function loraConfig(datasetPath, outputName, baseModel, resolution, steps, lr, networkDim) {
  const alpha = Math.floor(networkDim / 2);
  const saveEvery = Math.max(50, Math.floor(steps / 10));
  return {
    training_config: {
      base_model: baseModel,
      dataset_path: datasetPath,
      output_name: outputName,
      resolution: resolution,
      train_batch_size: 1,
      max_train_steps: steps,
      learning_rate: lr,
      network_dim: networkDim,
      network_alpha: alpha,
      optimizer: "AdamW8bit",
      lr_scheduler: "cosine_with_restarts",
      mixed_precision: "bf16",
      save_every_n_steps: saveEvery,
      caption_extension: ".txt",
    },
    recommended_kohya_command: [
      "python train_network.py",
      `  --pretrained_model_name_or_path "${baseModel}"`,
      `  --train_data_dir "${datasetPath}"`,
      `  --output_name "${outputName}"`,
      `  --resolution ${resolution}`,
      `  --max_train_steps ${steps}`,
      `  --learning_rate ${lr}`,
      `  --network_dim ${networkDim}`,
      `  --network_alpha ${alpha}`,
      "  --optimizer_type AdamW8bit",
      "  --mixed_precision bf16",
    ].join(" \\\n"),
    civitai_upload_steps: [
      "1. Finish training â€” your .safetensors file will be in the output folder.",
      "2. Go to https://civitai.com and sign in.",
      "3. Click your avatar â†’ 'Upload a Model'.",
      "4. Choose 'LoRA' as type and fill in the name and description.",
      "5. Upload your .safetensors file and add some sample images.",
      "6. Publish â€” your LoRA will appear in Civitai search within minutes.",
    ],
    tips: [
      "Use 10â€“30 high-quality images for best results.",
      "Write a caption (.txt) for every image describing the subject.",
      "Start with 500â€“1000 steps; increase if the style is not captured well.",
      "Lower lr (1e-4) for faces/characters; higher (2e-4) for art styles.",
    ],
  };
}

async function civitaiSearch(q) {
  const params = new URLSearchParams({ query: q, limit: 10, types: "LORA,Checkpoint" });
  const res = await fetch(`https://civitai.com/api/v1/models?${params}`, {
    headers: { Accept: "application/json" },
  });
  if (!res.ok) throw new Error(`Civitai returned status ${res.status}`);
  let data;
  try { data = await res.json(); }
  catch { throw new Error("Civitai returned an unexpected response. Try again in a moment."); }
  return (data.items || []).map(item => ({
    id:   item.id,
    name: item.name,
    type: item.type,
    nsfw: !!item.nsfw,
    tags: (item.tags || []).slice(0, 5),
    url:  `https://civitai.com/models/${item.id}`,
  }));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(id, btn) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll("#nav button").forEach(b => b.classList.remove("active"));
  document.getElementById("tab-" + id).classList.add("active");
  if (btn) btn.classList.add("active");
  if (id === "models") renderModels();
}

function setPreset(tab, value, btn) {
  state[tab] = state[tab] || {};
  if (tab === "enhance") state[tab].scale = value;
  else state[tab].mode = value;
  btn.closest(".preset-row").querySelectorAll(".preset-btn").forEach(b => b.classList.remove("selected"));
  btn.classList.add("selected");
}

function showResult(prefix, data) {
  const box = document.getElementById(prefix + "-result");
  document.getElementById(prefix + "-pre").textContent = JSON.stringify(data, null, 2);
  box.classList.add("visible");
  hideErr(prefix);
  box.scrollIntoView({ behavior: "smooth", block: "nearest" });
}

function showErr(prefix, msg) {
  const el = document.getElementById(prefix + "-err");
  if (el) { el.textContent = "âš ï¸  " + msg; el.classList.add("visible"); }
}

function hideErr(prefix) {
  const el = document.getElementById(prefix + "-err");
  if (el) el.classList.remove("visible");
}

function copyResult(preId) {
  const text = document.getElementById(preId).textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector(`[onclick="copyResult('${preId}')"]`);
    if (btn) { btn.textContent = "âœ… Copied!"; setTimeout(() => { btn.textContent = "ğŸ“‹ Copy"; }, 2000); }
  }).catch(() => {
    // Fallback for browsers without clipboard API
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
  });
}

function esc(s) {
  return String(s)
    .replace(/&/g, "&amp;").replace(/</g, "&lt;")
    .replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Tab handlers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function runT2V() {
  const idea = document.getElementById("t2v-prompt").value.trim();
  if (!idea) { showErr("t2v", "Please enter a video idea first."); return; }
  showResult("t2v", wanCombo(idea, state.t2v.mode));
}

function runI2V() {
  const path = document.getElementById("i2v-path").value.trim();
  const idea = document.getElementById("i2v-prompt").value.trim();
  if (!path) { showErr("i2v", "Please enter the image path or URL."); return; }
  if (!idea) { showErr("i2v", "Please describe the motion / camera."); return; }
  showResult("i2v", wanI2V(path, idea, state.i2v.mode));
}

function runI2I() {
  const path = document.getElementById("i2i-path").value.trim();
  const idea = document.getElementById("i2i-prompt").value.trim();
  const strength = parseFloat(document.getElementById("i2i-strength").value);
  if (!path) { showErr("i2i", "Please enter the image path or URL."); return; }
  if (!idea) { showErr("i2i", "Please describe the target style."); return; }
  showResult("i2i", wanI2I(path, idea, strength));
}

function runEnhance() {
  const path = document.getElementById("enhance-path").value.trim();
  if (!path) { showErr("enhance", "Please enter the image path or URL."); return; }
  showResult("enhance", wanEnhance(path, parseInt(state.enhance.scale, 10)));
}

async function runCivitai() {
  const q = document.getElementById("civitai-q").value.trim();
  if (!q) { showErr("civitai", "Please enter a search term."); return; }
  hideErr("civitai");
  const container = document.getElementById("civitai-results");
  container.innerHTML = "<span class=\"loader\"></span> Searching Civitaiâ€¦";
  try {
    const items = await civitaiSearch(q);
    if (!items.length) {
      container.innerHTML = "<p style=\"color:var(--muted);margin-top:12px\">No results found. Try different keywords.</p>";
      return;
    }
    container.innerHTML = items.map(item => `
      <div class="model-card">
        <div class="model-info">
          <div class="model-name">${esc(item.name)}</div>
          <span class="badge ${item.type === "LORA" ? "lora" : "checkpoint"}">${esc(item.type)}</span>
          ${item.tags.map(t => `<span class="badge">${esc(t)}</span>`).join("")}
          ${item.nsfw ? "<span class=\"badge\" style=\"border-color:#f44;color:#f44\">NSFW</span>" : ""}
        </div>
        <a href="${esc(item.url)}" target="_blank" rel="noopener noreferrer">Open â†—</a>
      </div>
    `).join("");
  } catch (e) {
    container.innerHTML = "";
    showErr("civitai", e.message);
  }
}

function runLora() {
  const dataset = document.getElementById("lora-dataset").value.trim();
  const output  = document.getElementById("lora-output").value.trim();
  const base    = document.getElementById("lora-base").value;
  const steps   = parseInt(document.getElementById("lora-steps").value, 10);
  const res     = parseInt(document.getElementById("lora-res").value, 10);
  const lr      = parseFloat(document.getElementById("lora-lr").value);
  const dim     = parseInt(document.getElementById("lora-dim").value, 10);

  if (!dataset) { showErr("lora", "Please enter the dataset folder path."); return; }
  if (!output)  { showErr("lora", "Please enter an output LoRA name."); return; }
  if (isNaN(lr) || lr <= 0) { showErr("lora", "Learning rate must be a positive number like 0.0001."); return; }
  if (isNaN(steps) || steps < 1) { showErr("lora", "Training steps must be a positive integer."); return; }
  showResult("lora", loraConfig(dataset, output, base, res, steps, lr, dim));
}

function renderModels() {
  const c = document.getElementById("models-cards");
  if (c.children.length) return; // already rendered
  const data = wanModels();
  const labels = { video_t2v: "ğŸ¬ Text-to-Video", video_i2v: "ğŸ–¼ï¸ Image-to-Video", image_i2i: "âœ¨ Image-to-Image", enhance: "ğŸ” Enhance / Upscale" };
  let html = "";
  for (const [k, v] of Object.entries(data)) {
    if (k === "notes") continue;
    html += `<div class="info-card"><h3>${labels[k] || k}</h3><ul>${v.map(m => `<li>${esc(m)}</li>`).join("")}</ul></div>`;
  }
  if (data.notes) {
    html += `<div class="info-card"><h3>ğŸ’¡ Tips</h3><ul>${data.notes.map(n => `<li>${esc(n)}</li>`).join("")}</ul></div>`;
  }
  c.innerHTML = html;
}

// Auto-render models tab on load
renderModels();
</script>
</body>
</html>
